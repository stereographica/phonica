# 開発プロセス

## 開発環境セットアップ

### 開発コマンド
```bash
# 開発
npm run dev          # 開発サーバー起動（Turbopack使用）
npm run build        # プロダクションビルド
npm run start        # プロダクションサーバー起動

# コード品質
npm run lint         # ESLint実行
npm test            # 全テスト実行
npx tsc --noEmit    # 型チェック（ファイル出力なし）

# データベース
npx prisma migrate dev    # マイグレーション実行
npx prisma studio        # Prisma Studio起動（DB確認用）
npx prisma generate      # Prisma Client生成
```

### アーキテクチャ概要
- **Framework**: Next.js 15 (App Router)
- **Language**: TypeScript
- **Database**: PostgreSQL + Prisma ORM
- **State Management**: Jotai
- **Data Fetching**: TanStack Query
- **UI Components**: shadcn/ui + Radix UI
- **Styling**: Tailwind CSS
- **Testing**: Jest + React Testing Library
- **Background Jobs**: BullMQ + Redis

### ディレクトリ構造
- `/src/app/` - Next.js App Router
  - `(app)/` - アプリケーションページ（共通レイアウト）
  - `(api)/` - APIルートグループ
- `/src/components/` - Reactコンポーネント（機能別）
- `/src/lib/` - ユーティリティ・共通ロジック
- `/src/types/` - TypeScript型定義
- `/prisma/` - DBスキーマ・マイグレーション
- `/docs/` - プロジェクトドキュメント

### データベーススキーマ
主要エンティティ：
- **Material**: 音声録音と関連メタデータ
- **Project**: 素材のグループ
- **Tag**: カテゴリ分類用ラベル
- **Equipment**: 録音機材マスタデータ

多対多リレーション: materials ↔ projects/tags/equipment

## 開発プロセス詳細

1. 指示の分析と計画
  - GitHub の issues には、対応しなければならない開発タスクが登録されています
  - ユーザが優先度の高いタスクを実行するように指示した場合は、この issues から `priority: {critical|high|medium|low}` のタグから優先度が高い順にを参照したうえで、タスクを選択してください
  - 主要なタスクを簡潔に要約してください。
  - `docs` ディレクトリ以下の各種ドキュメントを確認し、その制約内での実装方法を検討してください。 **技術スタックに記載のバージョンは変更せず、必要があれば必ず承認を得てください。**
  - 重要な要件と制約を特定してください。
  - 潜在的な課題をリストアップしてください。
  - タスク実行のための具体的なステップを詳細に列挙してください。
  - それらのステップの最適な実行順序を決定してください。
  - 実装前に以下の確認を行ってください
    - 既存の類似機能の有無
    - 同名または類似名の関数やコンポーネント
    - 重複する API エンドポイント
    - 共通化可能な処理の特定

  このセクションは、後続のプロセス全体を導くものなので、時間をかけてでも、十分に詳細かつ包括的な分析を行ってください。

### 設計パターン

1. **APIルート**: `/src/app/api/` 配下でRESTful規約に従う
2. **コンポーネント構造**: 機能別に整理（materials, master等）
3. **フォーム処理**: react-hook-form + zod検証
4. **テスト**: 各コンポーネント・APIルートに対応するテストファイル

2. タスクの実行
  - 最新のmainブランチを取得してから作業を開始します：
    ```bash
    git checkout main
    git pull origin main
    ```
  - 実装を開始するため、ブランチを作成します。ブランチ命名規則：
    - feature/issue-{番号}-{簡潔な説明}  （新機能）
    - fix/issue-{番号}-{簡潔な説明}     （バグ修正）
    - test/issue-{番号}-{簡潔な説明}    （テスト追加）
    - refactor/issue-{番号}-{簡潔な説明}（リファクタリング）
  - **重要**: mainブランチへの直接コミット・プッシュは禁止です。必ず別ブランチで作業し、PRを経由してください。
  - 実装前にissueのステータスを「status: in progress」に更新します。
  - 必要に応じてTodoWriteツールでタスク管理を行います。
  - 特定したステップを一つずつ実行してください。
  - テストをパスした時点でコミットを作成します。テストをパスしていないコードをコミットしてはいけません。
  - 各ステップの完了後、簡潔に進捗を報告してください。
  - 実装時は以下の点に注意してください：
    - 適切なディレクトリ構造の遵守
    - 命名規則の一貫性維持
    - 共通処理の適切な配置
  - TDD を実施してください。コードを生成するときは、それに対応するユニットテストを常に生成してください。コードを追加で修正したとき、`npm test` がパスすることを常に確認してください
    ```ts
    function add(a: number, b: number) {
      return a + b;
    }
    test("1+2=3", () => {
      expect(add(1, 2)).toBe(3);
    });
    ```
   - テストカバレッジ 100%を目指します。`*.ts` に対して、`*.test.ts` でユニットテストを書いてください
   - test.ts がない実装に対して、他のテストを参考にテストコードを追加してください
     1. `npm test` を実行して、現在のカバレッジを取得
     2. 今の状態から最もカバレッジが上がるテストコードを考察してから追加
     3. 再度カバレッジを計測して、数値が向上していることを確認
     4. **重要**: 全てのテストに成功し、Statements, Branches, Functions, Lines の各カバレッジが80%を超えていないとマージが出来ないため、超えるまでテストの追加とテスト実行を繰り返す
   - **テストベストプラクティス**: テストを書く・修正する際は、必ず `docs/testing_best_practices.md` のガイドラインに従ってください：
     - ユーザー中心のテストを書く（実装の詳細ではなく観察可能な動作に焦点）
     - 適切なモッキング戦略を使用
     - TDDの原則を正しく適用

3. 品質管理と問題対応
  - 各タスクの実行結果を迅速に検証してください。
  - 以下の品質チェックを実施してください：
    - [ ] `npm test` - 全テストがパス
    - [ ] `npm run lint` - lintエラーなし
    - [ ] `npx tsc --noEmit` - 型エラーなし
    - [ ] `npm run dev` - 開発サーバー起動確認
    - [ ] 全てのカバレッジ指標（Statements, Branches, Functions, Lines）が80%を超えている
  - GitHub Actions と同等のローカルテストを実施してください：
    ```bash
    # CI環境と同じ条件でテストを実行
    DATABASE_URL=postgresql://postgres:postgres@localhost:5432/test_db NODE_ENV=test npm test -- --coverage --watchAll=false
    
    # ビルドの確認（CI環境相当）
    DATABASE_URL=postgresql://user:password@localhost:5432/dummy_db npm run build
    
    # Lint & 型チェック
    npm run lint && npx tsc --noEmit
    
    # セキュリティ監査
    npm audit --audit-level=moderate
    ```
  - タスク内で発生したエラーについては確実に解決していることを確認してください。
  - 実施したタスク外で発生している既存のエラーについては、GitHub の issue を確認し、該当する対応用 issue が作成されていない場合はステップ 8 で追加してください。
  - エラーや不整合が発生した場合は、以下のプロセスで対応してください：
    - 問題の切り分けと原因特定（ログ分析、デバッグ情報の確認）
    - 対策案の作成と実施
    - 修正後の動作検証
    - デバッグログの確認と分析
  - 検証結果は以下の形式で記録してください
    - 検証項目と期待される結果
    - 実際の結果と差異
    - 必要な対応策（該当する場合）

## コード規約

- TypeScript strict modeを使用
- 既存のコンポーネント構造パターンに従う
- パスエイリアス（`@/` でsrcディレクトリ）を使用
- APIルートでは適切なエラーハンドリングを実装
- コミット前にデバッグコードとconsole.logを削除

## 品質チェックリスト

PRを作成する前に確認：
- [ ] 全テストがパス（`npm test`）
- [ ] lintエラーなし（`npm run lint`）
- [ ] 型エラーなし（`npx tsc --noEmit`）
- [ ] 開発サーバーが正常起動（`npm run dev`）
- [ ] 全カバレッジ指標（Statements, Branches, Functions, Lines）が80%超
- [ ] 新規ファイルには対応するテストファイルを作成

## 重要な注意事項

- 技術スタックのバージョンは承認なしに変更しない
- 既存の類似機能を確認し、重複実装を避ける
- UI/UXデザイン変更は事前承認が必要
- 指示されたら docs/issues.md のissueに対処
- 開発中に発見した問題は GitHub issue を作成

## バックグラウンドジョブ

ZIPファイル生成などのバックグラウンドタスクにBullMQを使用。ジョブキュー管理にはRedisが必要。

4. 最終確認
  - すべてのタスクが完了したら、成果物全体を評価してください。
  - 当初の指示内容との整合性を確認し、必要に応じて調整を行ってください。
  - 実装した機能に重複がないことを最終確認してください。
5. 結果報告
  以下のフォーマットで最終的な結果をまとめた上で、GitHub に Pull Request を作成します。Pull Request の作成にあたっては、該当する issue を関連付けます。PR本文には必ず `Closes #[issue番号]` を含めてください。

  ```markdown
  # {実施したタスク名}

  ## 概要

  [全体の要約を簡潔に記述]

  ## 実行ステップ

  1. [ステップ 1 の説明と結果]
  2. [ステップ 2 の説明と結果]
  ...

  ## 最終成果物

  [成果物の詳細や、該当する場合はリンクなど]

  ## 課題対応（該当する場合）

  - 発生した問題と対応内容
  - 今後の注意点

  ## 関連issue
  - Closes #[issue番号]

  ```

6. ユーザへの動作確認依頼
  ここまで完了したら、以下のセルフチェックを行った上で、ユーザにレビュー、及び動作確認の依頼をしてください。

  ## セルフチェックリスト
  - [ ] 新規ファイルにはテストファイルも作成済み
  - [ ] 全てのカバレッジ指標（Statements, Branches, Functions, Lines）が80%を超えている
  - [ ] 不要なconsole.logやデバッグコードを削除済み
  - [ ] CLAUDE.mdの更新が必要な場合は更新済み

  以下のフォーマットで依頼します。

  ```markdown
  # 動作確認依頼

  ## [ユーザに確認してほしい操作の表題]

  1. [ユーザに確認してほしい操作をステップを分割して具体的に書く]
  2. [ユーザに確認してほしい操作をステップを分割して具体的に書く]
  ...

  ## ユーザから特にフィードバックを受けたいこと

  [ユーザからのフィードバックを受けたい場合(ログ出力結果の共有依頼、挙動の正常性確認など)があれば書く]
  ```

  `npm run dev` で開発サーバをします。コンパイルエラーが起きず、正しく起動することを確認してください。ユーザから不具合が報告された場合は、コードを修正し不具合を解消するとともに、不具合の内容をユニットテストの新たなエッジケースとして追加してください。その後、「3. 品質管理と問題対応」からステップをやり直します。

7. Pull Request のマージ
  - ユーザーがレビューと動作確認を完了し、自身でPull Requestをマージします
  - Claudeはマージを行いません

8. タスク実行中に発生した課題の起票
  - タスク実行中に、改善したほうがよいことや問題を発見した場合は、GitHub に issue を作成します
  - 作成する issue の本文には以下を必ず含めます
    - 対象箇所
    - 問題点
    - 対応方針
    - 関連情報
    - 受け入れ条件
  - issue には適切な label を付与します。label 一覧を確認し、適切な label を選択してください

9. タスクの完了
  上記の実行が終了したら、一連のタスクは完了です。ユーザーに次の指示を仰いで下さい
