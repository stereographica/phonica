name: Test & Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup test database
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
      run: |
        npx prisma migrate deploy
        npx prisma generate

    - name: Run tests with coverage
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        NODE_ENV: test
      run: npm test -- --coverage --watchAll=false --silent

    - name: Test development server startup
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
      run: |
        timeout 30s npm run dev &
        DEV_PID=$!
        sleep 15
        # Check if process is still running
        if kill -0 $DEV_PID 2>/dev/null; then
          echo "âœ… Development server started successfully"
          kill $DEV_PID
        else
          echo "âŒ Development server failed to start"
          exit 1
        fi

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v5
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

    - name: Comment coverage report
      if: github.event_name == 'pull_request'
      uses: romeovs/lcov-reporter-action@v0.3.1
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        lcov-file: ./coverage/lcov.info
        delete-old-comments: true

    - name: Check coverage thresholds
      run: |
        node -e "
          const coverage = require('./coverage/coverage-summary.json');
          const total = coverage.total;
          
          console.log('ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸çµæœ:');
          console.log('- Statements:', total.statements.pct + '%');
          console.log('- Branches:', total.branches.pct + '%');
          console.log('- Functions:', total.functions.pct + '%');
          console.log('- Lines:', total.lines.pct + '%');
          
          // æœ€ä½é™ã®ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤
          const minCoverage = 80;
          
          if (total.statements.pct < minCoverage || 
              total.branches.pct < minCoverage || 
              total.functions.pct < minCoverage || 
              total.lines.pct < minCoverage) {
            console.log('âŒ ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒé–¾å€¤(' + minCoverage + '%)ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™');
            process.exit(1);
          } else {
            console.log('âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™');
          }
        "

  deploy-preview:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: test
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build
      env:
        DATABASE_URL: postgresql://user:password@localhost:5432/dummy_db

    - name: Comment build status
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const status = '${{ job.status }}' === 'success' ? 'âœ… ãƒ“ãƒ«ãƒ‰æˆåŠŸ' : 'âŒ ãƒ“ãƒ«ãƒ‰å¤±æ•—';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸš€ ãƒ“ãƒ«ãƒ‰çµæœ\n\n${status}\n\n- Node.js: 18\n- å®Ÿè¡Œæ™‚åˆ»: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}`
          });